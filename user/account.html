<!DOCTYPE html> 

<html lang="en"> 

  <head>

    <meta charset="UTF-8"> 

    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 

    <title>Your Account | NothingButTyler+</title> 
    
    <!--FONT AWESOME SCRIPT-->

<script src="https://kit.fontawesome.com/eeb01edac2.js" crossorigin="anonymous"></script>

<!--END OF FONT AWESOME SCRIPT-->
    
    <!--NEW STYLE-->
  <link rel="stylesheet" href="/css/main/style.css" />
  <link rel="stylesheet" href="/css/main/dashboard.css" />

    <!--<link rel="stylesheet" href="/css/dashboard-style-test.css" /> -->
    <link rel="stylesheet" href="/css/fading-popup-style.css" />

</head> 

      <body><!-- style="font-family: Arial, Helvetica, sans-serif;background: url('https://w3schools.com/favicon.ico')">-->
        
        <div id="popup" class="popup">
           <img src="https://tr.rbxcdn.com/180DAY-1c3cb7495f65bc2307e643ced5352513/420/420/Decal/Webp/noFilter" alt="X - Close button" title="Close" id="close-btn" height="30" width="30" style="float: right;" />
           <h1>Login successful</h1>
           <p>Logged in successfully!</p> 
        </div>
        
        <div style="background-color:red;text-align:center;padding:10px;margin-top:7px;font-size:12px;">This dashboard is still a work-in-progress. If something doesn't work, let NothingButTyler know and he will update it.</div>


              <div id="dashboard" class="hidden">
                
                
<div class="header"> 

  <a href="/user/dashboard" class="logo">NothingButTyler+</a>
    
             <div class="header-right"> 
                <a href="/user/dashboard">Dashboard</a>
                <a class="active" href="/user/account">Your Account</a>
               <a href="/user/settings">Settings</a>
                <a href="/user/pricing">Pricing</a>
                <a href="/user/help">Help/FAQ</a>
               <a hrer="/user/privacy">Privacy Policy</a>
                <a href="/user/terms">Terms of Use</a>
            </div>

    
  </div>
          <font color="white"><center>
            
            <img id="profile-pic" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT6jRFCljQ2Vu0MIfXO9HMopEcUbcOeDRWfCJa7NtESbQ&s=10" style="border-radius: 50px; margin-top: 20px;" alt="Profile Picture" width="100" height="100" />
            
            <h1>Account!</h1>
            <p>What can we help you with today? (Settings for <span id="displayName">Loading...</span>)</p>
            
            <hr/>

            <div id="account-info" style="text-align: left; max-width: 400px; margin: 0 auto; padding-bottom: 20px;">
                <h2>Your Details</h2>
                <p><strong>Login Email:</strong> <span id="authEmail">Loading...</span></p>
                <p><strong>Account ID (UID):</strong> <span id="authUid">Loading...</span></p>
                <p><strong>Member Since:</strong> <span id="creationTime">Loading...</span></p>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button id="goToSettingsButton" class="button-29">
                        <i class="fa-solid fa-gear"></i> Manage Account Settings
                    </button>
                </div>
            </div>

            <hr/>

            <div style="max-width: 500px; margin: 0 auto; padding: 20px 0;">
                <h2>Switching to a new subscription?</h2>
                <p>Click the button below to review what you can get from free, pro, and premium!</p>
                <button id="seePricingButton" class="button-29"><i class="fa-solid fa-dollar-sign"></i> See Pricing</button>
            </div>
            
            <hr/>

            <div style="max-width: 500px; margin: 0 auto; padding: 20px 0;">
                <h2>Confused, stuck, or reporting a bug?</h2>
                <p>NothingButTyler is here for you. Join his Discord server below to open a support ticket.</p>
                <button id="joinDiscordButton" class="button-29"><i class="fa-brands fa-discord"></i> Join the Discord Server</button>
            </div>

            <hr/>

            <div id="accountManagement" style="max-width: 500px; margin: 0 auto; padding: 20px 0;">
                <h2>Account Recovery</h2>
                <button id="forgotPinButton" class="button-29" style="margin-right: 10px;">
                  <i class="fas fa-key"></i> Send PIN Reset Link
                </button>
                <p id="actionStatus" style="color: yellow; margin-top: 10px;"></p>
            </div>
            
            <hr />

            <button id="backToDashboardButton" class="button-29" style="margin-right: 10px; margin-bottom: 20px;">
                <i class="fa-solid fa-backward"></i> Back to Dashboard
            </button>
            
            <button class="sign-out-btn" id="signOutButton">Sign Out</button>

            <footer>
                <div style="background-color:transparent;text-align:center;padding:10px;margin-top:7px;font-size:12px;color: white;">Copyright &copy; 2025 by NothingButTyler. All rights reserved.</div>
            </footer>
        </center></font>

    <script>
        document.getElementById('signOutButton').addEventListener('click', function() {
            // Simulate sign-out process (like clearing session data, etc.)
            alert('You have been signed out. Now taking you back to the homepage.');
            // Optionally, redirect to login page or home
            window.location.href = "/";
        });
    </script>


              </div> 

                <!--<div style="background-color:#f1f1f1;text-align:center;padding:10px;margin-top:7px;font-size:12px;">Copyright &copy; 2025 by NothingButTyler. All rights reserved.</div>-->
                
                   <footer>    <hr />    <div style="background-color:transparent;text-align:center;padding:10px;margin-top:7px;font-size:12px;color: white;">Copyright &copy; 2025 by NothingButTyler. All rights reserved.</div>
      </footer></center>

               <script src="https://apis.google.com/js/platform.js" async defer></script> 

            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 

         <script src="/js/dashboard-script-test.js"></script>
        
        <script src="/fp/fading-popup-script.js"></script>

  
  <!--GOOGLE FIREBASE SCRIPT-->
  
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
    // ðŸš¨ CRITICAL FIX: USING NEW WORKING KEYS (nothingbuttylerplusv2)
    const firebaseConfig = {
      apiKey: "AIzaSyCxg9yjBpv0lwhG1dBpqKpUJRrQEXCsavI",
      authDomain: "nothingbuttylerplusv2.firebaseapp.com",
      projectId: "nothingbuttylerplusv2",
      storageBucket: "nothingbuttylerplusv2.firebasestorage.app",
      messagingSenderId: "478539772644",
      appId: "1:478539772644:web:aa99972afac494f9bd32f1",
      measurementId: "G-TBRJNP38KP"
    };
    
    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    var auth = app.auth(); 
    var db = app.firestore(); 
    
    // Helper function to format creation date for readability
    function formatCreationTime(timestamp) {
        // user.metadata.creationTime is often a standard UTC date string.
        // We pass the string directly to the Date constructor for reliable parsing.
        const date = new Date(timestamp); 
        
        // Always check if the date object is valid before formatting
        if (isNaN(date)) {
            return "Error: Could not parse date.";
        }
        
        // Use consistent formatting
        const options = { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit' // Added seconds for precision
        };
        return date.toLocaleDateString(undefined, options);
    }


    // -----------------------------------------------------------
    // 1. SECURITY & DATA LOADING CHECK (THE FIX IS HERE)
    // -----------------------------------------------------------
    auth.onAuthStateChanged(function(user) {
        if (user) {
            // User is signed in. Get their account details.
            
            // Show the dashboard content
            document.getElementById('dashboard').classList.remove('hidden');

            // --- START: DISPLAY AUTH DATA (FIX) ---
            document.getElementById('authEmail').textContent = user.email;
            document.getElementById('authUid').textContent = user.uid;
            
            const creationMs = user.metadata.creationTime;
            document.getElementById('creationTime').textContent = formatCreationTime(creationMs);
            // --- END: DISPLAY AUTH DATA (FIX) ---


            db.collection("users").doc(user.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const accountName = doc.data().accountName;
                        const profilePicURL = doc.data().profilePicURL;

                        // Display name in the welcome message/header
                        document.getElementById('displayName').textContent = accountName; 
                        document.getElementById('profile-pic').src = profilePicURL;
                        
                    } else {
                        // User Data Missing
                        document.getElementById('displayName').textContent = "(User Data Missing)";
                    }
                })
                .catch((error) => {
                    console.error("Error fetching user data:", error);
                });


            // -----------------------------------------------------------
            // 3. NAVIGATION & ACTION LISTENERS (Re-attaching your working logic)
            // -----------------------------------------------------------
            
            // Go To Settings Button
            document.getElementById('goToSettingsButton').addEventListener('click', function() {
                window.location.href = "settings.html";
            });
            
                 // Send PIN Reset Link Button
            document.getElementById('forgotPinButton').addEventListener('click', function() {
                const actionStatus = document.getElementById('actionStatus');
                
                // 1. Get the email address from the new input field
                const resetEmail = document.getElementById('resetEmailInput').value.trim();
                
                if (!resetEmail) { 
                    actionStatus.textContent = "Please enter an email address to send the reset link to."; 
                    return; 
                }
                
                // Clear any previous status message
                actionStatus.textContent = "Sending PIN reset link to " + resetEmail + "...";
                
                // 2. Use the user-provided email to send the reset link
                auth.sendPasswordResetEmail(resetEmail)
                    .then(() => {
                        actionStatus.textContent = `Success! A PIN reset link has been sent to: ${resetEmail}`;
                        
                        // Optional: Clear the input field after success
                        document.getElementById('resetEmailInput').value = ''; 
                    })
                    .catch((error) => {
                        // Firebase will return an error if the email is not registered (e.g., if the user types the wrong email).
                        actionStatus.textContent = `Error sending reset email. Please ensure the email is correct. (${error.message})`;
                        console.error("Error sending PIN reset:", error);
                    });
            });


            // Back to Dashboard Button
            document.getElementById('backToDashboardButton').addEventListener('click', function() {
                window.location.href = "/user/dashboard";
            });

            // See Pricing Button
            document.getElementById('seePricingButton').addEventListener('click', function() {
                window.location.href = "/users/pricing"; 
            });

            // Join Discord Button (Placeholder URL)
            document.getElementById('joinDiscordButton').addEventListener('click', function() {
                // You will need to replace this placeholder URL with your actual Discord invite link
                window.open("https://discord.gg/s2KB2FSFpZ", "_blank"); 
            });


        } else {
            // User is NOT signed in. Redirect to the login page immediately.
            console.log("User is not logged in. Redirecting to index.html");
            window.location.href = "/"; 
        }
    });

    // NOTE: We removed the duplicate signOutButton listener and put the working one inside the auth.onAuthStateChanged block for better cleanup/logic flow.

</script>


<script src="/fp/fading-popup-script.js"></script>
<script src="/js/dashboard-script-test.js"></script>
<script src="/js/dashboard.js"></script>
  
<!--END OF GOOGLE FIREBASE SCRIPT-->
     </body>

</html>