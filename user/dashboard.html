<!DOCTYPE html> 

<html lang="en"> 

  <head>

    <meta charset="UTF-8"> 

    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 

    <title>Dashboard | NothingButTyler+</title> 
    
    <!--NEW STYLE-->
  <link rel="stylesheet" href="/css/main/style.css" />
  <link rel="stylesheet" href="/css/main/dashboard.css" />

    <!--<link rel="stylesheet" href="/css/dashboard-style-test.css" /> -->
    <link rel="stylesheet" href="/css/fading-popup-style.css" />

</head> 

      <body><!-- style="font-family: Arial, Helvetica, sans-serif;background: url('https://w3schools.com/favicon.ico')">-->
        
        <div id="popup" class="popup">
           <img src="https://tr.rbxcdn.com/180DAY-1c3cb7495f65bc2307e643ced5352513/420/420/Decal/Webp/noFilter" alt="X - Close button" title="Close" id="close-btn" height="30" width="30" style="float: right;" />
           <h1>Login successful</h1>
           <p>Logged in successfully!</p> 
        </div>
        
        <div style="background-color:red;text-align:center;padding:10px;margin-top:7px;font-size:12px;">This dashboard is still a work-in-progress. If something doesn't work, let NothingButTyler know and he will update it.</div>


              <div id="dashboard" class="hidden">
                
                
<div class="header"> 

  <a href="/user/dashboard" class="logo">NothingButTyler+</a>

  <div class="header-right"> 

    <a class="active" href="/user/dashboard">Dashboard</a>
    
    <a href="/user/leaks">Leaks</a>
    
    <a href="/user/webleaks">Website Leaks</a>

    <a href="/user/upcoming">Upcoming Videos</a> 

    <a href="/user/progress">Progress on Roblox Games</a>
    
    <a href="/user/coolclips">Cool Clips</a>
    
    <a href="/user/upcomingmovies">Upcoming Roblox Movies</a>
    
    <a href="/user/account">Your Account</a>
    
  </div>
  <font color="white"><center>
        <img id="profile-pic" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT6jRFCljQ2Vu0MIfXO9HMopEcUbcOeDRWfCJa7NtESbQ&s=10" style="border-radius: 50px;" alt="Profile Picture" width="50" height="50" />
    <p id="welcome-message">Loading Account...</p>
    
                     <h1>Welcome to Your Dashboard</h1>
                 
                 <div id="dashboard-content" style="max-width: 900px; margin: 20px auto; padding: 20px;">
                    
                    <div id="kpi-container" class="kpi-grid">
                        <div class="kpi-card" id="total-leaks"><h3>Total Leaks</h3><p class="kpi-value">...</p></div>
                        <div class="kpi-card" id="upcoming-videos"><h3>Upcoming Videos</h3><p class="kpi-value">...</p></div>
    <div class="kpi-card" id="new-content-this-week"><h3>New Content This Week</h3><p class="kpi-value">...</p></div>
    <div class="kpi-card" id="unreleased-games"><h3>Unreleased Games</h3><p class="kpi-value">...</p></div>
    <div class="kpi-card" id="oldest-leak-date"><h3>Content Since</h3><p class="kpi-value">...</p></div>
    <div class="kpi-card" id="content-categories"><h3>Content Categories</h3><p class="kpi-value">...</p></div>
</div>


                    <h2>Recent Exclusive Content</h2>
                    <div id="recent-activity-container" class="recent-activity-box">
                        <p id="recent-loading-status">Loading latest updates...</p>
                    </div>


                 </div>
    
    <!-- KPI CARD STYLING-->
    <style>
    /* --- Dashboard Specific Styles --- */

/* KPI Grid for layout */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
    text-align: center;
}

/* Individual KPI Card Style */
.kpi-card {
    background-color: #0d123d; /* Darker blue to contrast with background */
    color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    border-top: 5px solid dodgerblue; /* Highlight color */
}

.kpi-card h3 {
    margin-top: 0;
    font-size: 1.1em;
    color: #a0a0a0;
}

.kpi-value {
    font-size: 2.5em;
    font-weight: bold;
    color: cyan; /* Highlight color */
    margin: 0;
}

/* Recent Activity Box */
.recent-activity-box {
    background-color: #0d123d;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    min-height: 150px;
}

.recent-item {
    padding: 10px 0;
    border-bottom: 1px dashed #333;
}

.recent-item:last-child {
    border-bottom: none;
}

.recent-item p {
    margin: 5px 0;
}

.recent-item .source {
    font-weight: bold;
    color: dodgerblue;
}

.recent-item .date {
    font-size: 0.8em;
    color: #aaa;
    float: right;
}

    </style>
    <!--END OF KPI CARD STYLING-->
    <!-- KPI CARD SCRIPT-->
    <script>
    
                // -----------------------------------------------------------
            // 3. DASHBOARD DATA LOADING (KPIs and Recent Activity)
            // -----------------------------------------------------------

            // --- A. Load Recent Leaks (Limit to 3) ---
            db.collection("leaks").orderBy("timestamp", "desc").limit(3).get()
                .then(querySnapshot => {
                    const recentActivityContainer = document.getElementById('recent-activity-container');
                    const recentLoadingStatus = document.getElementById('recent-loading-status');
                    recentLoadingStatus.style.display = 'none';
                    
                    if (querySnapshot.empty) {
                        recentActivityContainer.innerHTML = '<p style="color: #aaa;">No recent content available.</p>';
                        return;
                    }

                    let recentHTML = '';
                    querySnapshot.forEach(doc => {
                        const leak = doc.data();
                        const date = leak.timestamp ? leak.timestamp.toDate().toLocaleDateString() : 'N/A';
                        
                        recentHTML += `
                            <div class="recent-item">
                                <span class="source">LEAK:</span> ${leak.title}
                                <span class="date">${date}</span>
                            </div>
                        `;
                    });
                    recentActivityContainer.innerHTML = recentHTML;
                })
                .catch(error => {
                    document.getElementById('recent-loading-status').textContent = "Error loading recent leaks.";
                    console.error("Error loading recent leaks:", error);
                });


            // --- B. Load Total Leaks Count (KPI) ---
            db.collection("leaks").get()
                .then(querySnapshot => {
                    const totalLeaks = querySnapshot.size;
                    document.querySelector('#total-leaks .kpi-value').textContent = totalLeaks;
                })
                .catch(error => {
                    document.querySelector('#total-leaks .kpi-value').textContent = 'Error';
                    console.error("Error counting leaks:", error);
                });
                
            // NOTE: You'll need to create a 'videos' collection later for the 'Upcoming Videos' KPI to work!
            // For now, it will just show an error or 0.

                // -----------------------------------------------------------
            // 4. ADVANCED DASHBOARD KPIs
            // -----------------------------------------------------------

            // Calculate the date 7 days ago for "New Content This Week"
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const sevenDaysAgoTimestamp = firebase.firestore.Timestamp.fromDate(sevenDaysAgo);

            let newContentCount = 0;
            const contentPromises = [];

            // --- A. New Content This Week (Query 1: leaks) ---
            const leaksPromise = db.collection("leaks")
                .where("timestamp", ">=", sevenDaysAgoTimestamp) // 
                .get();
            contentPromises.push(leaksPromise);
            
            // --- B. Unreleased Roblox Games (KPI) ---
            db.collection("progress").where("status", "==", "Unreleased").get()
                .then(querySnapshot => {
                    const unreleasedCount = querySnapshot.size;
                    document.querySelector('#unreleased-games .kpi-value').textContent = unreleasedCount;
                })
                .catch(error => {
                    document.querySelector('#unreleased-games .kpi-value').textContent = 'Error';
                    console.error("Error counting unreleased games:", error);
                });
                
            // --- C. Upcoming Videos (KPI) ---
            db.collection("upcomingVideos").get()
                .then(querySnapshot => {
                    const videoCount = querySnapshot.size;
                    document.querySelector('#upcoming-videos .kpi-value').textContent = videoCount;
                    
                    // --- Adding the Videos collection to the "New Content This Week" calculation ---
                    // You'll need to manually iterate here or ensure your videos have a 'timestamp' field
                    querySnapshot.forEach(doc => {
                         const video = doc.data();
                         // Assuming video doc has a 'timestamp' field
                         if (video.timestamp && video.timestamp.seconds * 1000 >= sevenDaysAgo.getTime()) {
                             newContentCount++;
                         }
                    });
                })
                .catch(error => {
                    document.querySelector('#upcoming-videos .kpi-value').textContent = 'Error';
                    console.error("Error counting upcoming videos:", error);
                });


            // --- D. Final Calculation for New Content This Week ---
            // Using Promise.all to wait for all asynchronous counts to complete.
            Promise.all(contentPromises)
                .then(results => {
                    // This adds the count from the 'leaks' collection (and any others added to contentPromises)
                    newContentCount += results.reduce((total, snapshot) => total + snapshot.size, 0);
                    
                    // The video count logic above handles its own contribution.
                    document.querySelector('#new-content-this-week .kpi-value').textContent = newContentCount;
                })
                .catch(error => {
                    document.querySelector('#new-content-this-week .kpi-value').textContent = 'Error';
                    console.error("Error counting new content:", error);
                });

            // NOTE on contentCategories: This requires a manual setup and count, which is more complex. We'll skip it for now.

    
    </script>
    <!-- END OF KPI CARD SCRIPT-->

                 <div id="user-info"></div> 
                <button class="sign-out-btn" id="signOutButton">Sign Out</button>

    <script>
        document.getElementById('signOutButton').addEventListener('click', function() {
            // Simulate sign-out process (like clearing session data, etc.)
            alert('You have been signed out. Now taking you back to the homepage.');
            // Optionally, redirect to login page or home
            window.location.href = "/";
        });
    </script>


              </div> 

                <!--<div style="background-color:#f1f1f1;text-align:center;padding:10px;margin-top:7px;font-size:12px;">Copyright &copy; 2025 by NothingButTyler. All rights reserved.</div>-->
                
                   <footer>    <hr />    <div style="background-color:transparent;text-align:center;padding:10px;margin-top:7px;font-size:12px;color: white;">Copyright &copy; 2025 by NothingButTyler. All rights reserved.</div>
      </footer></center>

               <script src="https://apis.google.com/js/platform.js" async defer></script> 

            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 

         <script src="/js/dashboard-script-test.js"></script>
        
        <script src="/fp/fading-popup-script.js"></script>

  
  <!--GOOGLE FIREBASE SCRIPT-->
  
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
    // ðŸš¨ CRITICAL FIX: USING NEW WORKING KEYS (nothingbuttylerplusv2)
    const firebaseConfig = {
      apiKey: "AIzaSyCxg9yjBpv0lwhG1dBpqKpUJRrQEXCsavI",
      authDomain: "nothingbuttylerplusv2.firebaseapp.com",
      projectId: "nothingbuttylerplusv2",
      storageBucket: "nothingbuttylerplusv2.firebasestorage.app",
      messagingSenderId: "478539772644",
      appId: "1:478539772644:web:aa99972afac494f9bd32f1",
      measurementId: "G-TBRJNP38KP"
    };
    
    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    var auth = app.auth(); 
    var db = app.firestore(); 

    // -----------------------------------------------------------
    // 1. SECURITY & DATA LOADING CHECK
    // -----------------------------------------------------------
    auth.onAuthStateChanged(function(user) {
        if (user) {
            // User is signed in. Get their account details.
            
            // Show the dashboard content now that we know they are logged in
            document.getElementById('dashboard').classList.remove('hidden');

            db.collection("users").doc(user.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const accountName = doc.data().accountName;
                        const profilePicURL = doc.data().profilePicURL;

                        // Display welcome message and profile picture
                        document.getElementById('welcome-message').textContent = `Welcome, ${accountName}!`;
                        document.getElementById('profile-pic').src = profilePicURL;
                        
                        // Hide the "Loading Account..." message that was in the HTML
                        // document.getElementById('user-info').style.display = 'none';

                    } else {
                        // This should not happen if signup worked correctly
                        document.getElementById('welcome-message').textContent = "Welcome, (User Data Missing)";
                    }
                })
                .catch((error) => {
                    console.error("Error fetching user data:", error);
                });

        } else {
            // User is NOT signed in. Redirect to the login page immediately.
            console.log("User is not logged in. Redirecting to index.html");
            window.location.href = "/"; 
        }
    });

    // -----------------------------------------------------------
    // 2. LOGOUT FUNCTIONALITY (Correct Firebase Call)
    // -----------------------------------------------------------
    document.getElementById('signOutButton').addEventListener('click', function() {
        auth.signOut()
            .then(() => {
                // Sign-out successful. Redirect to login page.
                window.location.href = "/";
            })
            .catch((error) => {
                console.error("Logout Error:", error);
                alert("Logout failed. Check console for details.");
            });
    });

</script>

<script src="/fp/fading-popup-script.js"></script>
<script src="/js/dashboard-script-test.js"></script>
<script src="/js/dashboard.js"></script>
  
<!--END OF GOOGLE FIREBASE SCRIPT-->
     </body>

</html>